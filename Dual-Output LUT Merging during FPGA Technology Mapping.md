# **《Dual-Output LUT Merging during FPGA Technology Mapping》**

**一、研究背景**

现代商用现场可编程门阵列（FPGA）架构支持双输出查找表（LUT），但现有技术在技术映射阶段未充分利用这一特性，导致LUT合并率低。本文提出一种在技术映射阶段直接生成双输出LUT并进行合并的方法，以提高映射质量。

**二、关键概念与定义**

1. **组合电路**：用有向无环图（DAG）表示，节点对应逻辑门，边对应连接逻辑门的导线，包括初级输入（PI）和初级输出（PO）。
2. **单输出割**：对于一个节点，单输出割是一组节点，满足从PI到该节点的每条路径都至少经过割集中的一个节点。
3. **双输出割**：对于两个不同根节点的单输出割，它们的双输出割是它们的并集，且满足从PI到任一根节点的路径都经过割集中的至少一个节点。
4. **双输出LUT**：一些现代FPGA中的LUT可分为两个小LUT使用，需满足输入数量、每个LUT输入数量和共享输入数量的约束。

**三、问题阐述**

给定一个单限界有向无环图和支持双输出LUT的架构，目标是从图中选择单节点和节点对，生成覆盖所有非PI节点的割集，以最小化映射后网表的延迟和面积。

**四、双输出LUT映射流程**

1. **映射流程概述**
    - 将组合电路转换为2限界有向无环图。
    - 进行多次映射迭代，包括深度优化和面积优化，直到收敛或达到最大迭代次数。
2. **优先级割计算**
    - 为每个节点计算有限的优先级割，包括单可行割和双可行割。
    - 从PI开始，按拓扑顺序计算，存储最多\(P\%\)个优先级割。
3. **全局双输出割合并**
    - 以反拓扑顺序遍历图，维护映射边界列表。
    - 选择最深节点作为割根，合并双输出割，保证不增加总延迟。
4. **局部优化**
    - 通过提高割合并率进一步减少面积。
    - 计算使用节点的所需深度，确保优化过程中不增加延迟。
    - 在每几层中对映射网表进行优化，构建合并图并计算最大匹配。

**五、割选择启发式方法**

1. **单输出割选择**：回顾了常用的单输出割选择启发式指标，如深度、精确面积、面积流、割大小、扇入引用、精确边和边流等。
2. **双输出割选择**：扩展了启发式指标以支持双输出割选择，遵循两个原则，即优先选择具有更多共享输入的双输出割，以及在其他情况下优先选择代表单输出割。
3. **启发式指标组合**：在不同的映射迭代中使用不同的启发式指标组合，以平衡延迟和面积优化。

**六、实验评估**

1. **实验设置**：使用C++实现算法，在Intel Xeon 2-CPU 10核计算机上运行，选取EPFL基准套件中的13个大型电路进行评估。
2. **结果与分析**
    - 与ABC工具相比，本文的映射流程在不增加延迟的情况下，平均节省了9.14%、13.98%和5.68%的双输出LUT面积，合并率更高。
    - 局部优化能额外提高1.81%的合并率和2.10%的面积。
    - 不同的\(\langle PGICL\rangle\)和\(P\%\)对结果有影响，多数情况下双输出面积在一定迭代次数后收敛。
    - LUT分布分析表明，本文方法生成的双输出LUT在数量和质量上均优于ABC。
    - 本文的映射流程运行时间相对较长，但仍适用于大型工业电路。

**七、相关工作**

介绍了现有的单输出LUT技术映射流程和一些考虑双输出LUT的工作，指出它们存在的问题，如LUT合并率低等。

**八、结论**

本文提出的在技术映射阶段合并双输出LUT的方法，通过全局割合并和局部优化，以及扩展的启发式指标，提高了LUT合并率和面积效率，同时不增加延迟。





# How to determine the maximum fan-out free cone(MFFC) for a node?

确定一个节点的最大无扇出锥（MFFC）通常需要对给定的有向无环图进行分析和计算。

以下是一种常见的方法来确定节点的 MFFC：

1. 首先，从给定节点开始，沿着所有的传递扇入边找到所有可以到达该节点的节点，这些节点构成了该节点的扇入锥。

2. 然后，在扇入锥中，逐个检查每个节点到初级输出（POs）的所有路径。

3. 如果某个节点满足从它到 POs 的所有路径都经过给定节点，那么这个节点就属于该给定节点的 MFFC。

4. 重复这个过程，直到检查完扇入锥中的所有节点，最终得到的就是给定节点的最大无扇出锥。

需要注意的是，具体的实现方法可能会因图的表示方式和算法的不同而有所差异。在实际应用中，可能会使用更高效的算法和数据结构来进行 MFFC 的计算。


# What is the heuristic algorithm?

启发式算法(heuristic algorithm)是相对于最优化算法提出的。一个问题的最优算法求得该问题每个实例的最优解。启发式算法可以这样定义：一个基于直观或经验构造的算法，在可接受的花费（指计算时间和空间）下给出待解决组合优化问题每一个实例的一个可行解，该可行解与最优解的偏离程度一般不能被预计。现阶段，启发式算法以仿自然体算法为主，主要有蚁群算法、模拟退火法、神经网络等。


# LUT of different architecture

## UltraScale+

Virtex和Kintex都是赛灵思（Xilinx）公司推出的FPGA（现场可编程门阵列）系列产品。

**Virtex系列**：
- 通常定位为高端FPGA产品，具有高性能、大容量逻辑资源、高速度和丰富的功能特性。
- 适用于对性能要求极高的应用场景，如通信基础设施、航空航天、高端医疗设备等领域。

**Kintex系列**：
- 一般处于中高端定位，在性能和成本之间提供了较好的平衡。
- 适合于一些对性能有较高要求但同时也需要考虑成本因素的应用，如工业自动化、视频处理、无线通信等领域。

以下是对Xilinx不同Virtex UltraScale系列产品的介绍：

**UltraScale系列**：

UltraScale架构代表了Xilinx在FPGA技术上的重大进步。它引入了很多先进的特性，如高容量、高性能的逻辑资源、增强的时钟管理和高速串行收发器等。该系列产品在通信、数据中心、工业控制等多个领域得到广泛应用。

**UltraScale+系列**：

UltraScale+在UltraScale的基础上进一步提升了性能和功能。它通常具有更高的逻辑密度、更快的时钟速度和更低的功耗。

 - **UltraScale+ 58G**：突出特点是具有高达58Gbps的高速串行收发器，非常适合对数据传输速率要求极高的应用，如高速通信系统、数据中心互联等。

 - **UltraScale+ HBM（High Bandwidth Memory）**：集成了高带宽内存（HBM），能够提供极高的内存带宽，对于需要处理大量数据且对内存访问速度有严格要求的应用，如高性能计算、人工智能和大数据处理等，具有很大的优势。这种集成HBM的版本可以大大减少系统的复杂性和功耗，同时提高数据处理的效率。

## Versal


### 一、LUT概述
所有可配置逻辑块（CLB）中的查找表都是6输入查找表（6LUT）。6LUT通过额外的复用增强，以实现更多功能。

### 二、LUT的新复用器功能
Versal架构中的LUT顶部和底部附近的两个复用器是新加入的。它们是由静态存储单元控制的复用器，用于以下目的：
1. 可级联LUT到LUT的连接（O6 -> A5）。
2. 实现最多六个输入的双LUT功能（之前的架构中为五个输入）。
3. 用于进位逻辑路径。

这些复用器默认选择A5输入，也可以被编程为不选择任何输入，在这种情况下其输出被驱动为高电平。
![](paper/versal_lut_features.png)

### 三、LUT输出
LUT有四个输出。prop输出仅用于进位逻辑，在CLB外部不可见。对于标准6LUT模式，O6用作输出。对于双5LUT模式，O5_1和O5_2都用于将两个函数输出带到逻辑中。

### 四、LUT级联
在逻辑上相邻的LUT之间存在级联复用器路径（A->B->C->D->E->F->G->H方向，但不能反向）。一个LUT的O6输出通过级联复用器连接到下一个LUT的A5引脚。目的是在两个LUT级之间创建一条短而快速的路径，以减少关键路径上的延迟并减少外部布线需求。最佳地使用级联可能需要在CLB内交换LUT的位置，以便在对周围逻辑的影响较小的情况下将关键LUT放置在一起。请注意，级联连接在CLB切片（8个LUT）内是自包含的，不会跨越切片边界。另外，奇数连接通过进位链到达后续LUT。当用作级联（而不是用于进位逻辑）时，进位块被配置为使得prop输出强制使进位逻辑充当这些级联路径的通道。
![](paper/versal_cascade_pattern.png)

### 五、LUTRAM
Versal架构中的LUTRAM（查找表随机存取存储器）相比以前的架构进行了简化：
1. LUTRAM单元可用于64位和32位深度。任何更深的深度将被分解为一组这些单元和一个复用器树。没有高阶地址解码电路，每个LUT有六个写地址输入。没有MUXF7、MUXF8、MUXF9单元。可以使用额外的逻辑实现更深的LUTRAM。
2. 支持双边沿时钟。
3. 有专用的LRAM_WE站点输入用于LUTRAM写使能。
4. LUTRAM或SRL（移位寄存器）可以与SLICEM中的逻辑LUT组合。
![](paper/versal_lutram_write_decoder.png)

在Versal架构中，每个CLB的一半LUT是支持LUTRAM和SRL配置的。在LUTRAM模式下，一个LUT可以配置为32位或64位RAM。在SRL模式下，一个LUT可以配置为32位或两个16位移位寄存器。分布式RAM可以组合以创建具有各种大小和功能的LUTRAM或SRL块。

地址线屏蔽电路存在于每列八个LUT上，而不是每个LUT基础上。软件将SRL、LUTRAM或LUT打包在8-LUT集群中，但不是这些的组合。SLICEM中的4-LUT集群基于LUT列。{A_M,C_M,E_M,G_M}是一个集群，{B_M,D_M,F_M,H_M}是另一个。集群可以包含LUTRAM、SRL或常规逻辑LUT。在4-LUT集群中不允许超过一种LUT类型的组合。每个CLB的一半可以有LUTRAM或SRL，但不能同时有。如果在一个8-LUT集群中使用LUTRAM，同一侧的另一个8-LUT集群只能是常规LUT或LUTRAM。同样，如果在一个8-LUT集群中使用SRL，同一侧的另一个8-LUT集群只能是常规LUT或SRL。LUTRAM和SRL可以在同一个CLB中，但它们必须在不同的侧。每个8-LUT集群只能有常规LUT、配置为LUTRAM的LUT或配置为SRL的LUT。在8-LUT集群中不允许其他LUT类型的组合。

Versal架构中另一个新的不同之处是移除了宽功能复用器（F7、F8、F9）。以前这些用于实现对更深的LUTRAM和SRL模式的硬件支持。对于大于64位深度的LUTRAM以及使用动态抽头选择的大于32位的SRL，必须使用软逻辑（例如实现为动态复用器的LUT）。还需要外部LUT来创建写使能逻辑。以前的架构使用硬写解码器，这可以实现更快的最佳情况时序，但没有布局灵活性。通过要求写使能逻辑为软逻辑，更深的LUTRAM配置中的各个LUT可以在切片内甚至在不同切片之间进行洗牌（尽管每个单独的切片将需要使用H-LUT的输入引脚用于写地址）。

Versal架构支持以前架构中支持的所有LUTRAM模式。分布式RAM可以以各种方式组合以存储更大数量的数据。RAM元素可配置为实现以下配置：单端口32 x（1到16）位RAM、双端口32 x（1到4）位RAM、四端口32 x（1到4）位RAM、简单双端口32 x（1到14）位RAM、单端口64 x（1到8）位RAM、双端口64 x（1到4）位RAM、四端口64 x（1到2）位RAM、八端口64 x 1位RAM、简单双端口64 x（1到7）位RAM、单端口128 x（1到4）位RAM、双端口128 x 1位RAM、四端口128 x 1位RAM、单端口256 x（1到2）位RAM、双端口256 x 1位RAM、单端口512 x 1位RAM。对于LUTRAM 32x1、32x2和64x1有专用的硬件支持。任何更大的尺寸都需要用LUT创建的软逻辑来支持读写地址解码。

### 六、移位寄存器（Shift Registers）
Versal架构CLB移位寄存器与以前架构中使用的非常相似，6-LUT支持32位SRL，5-LUT/6-LUT对支持一对16位SRL。32位SRL可以使用6-LUT的SIN和SOUT引脚通过专用移位链连接在一起。每个切片有一个初始SIN移位输入和SOUT移位输出，分别连接到上下相邻的CLB中的切片。

与SRL相关的显著变化在于SRL的连接方式：
1. 列中切片之间的SIN/SOUT移位链在时钟区域的中心和时钟区域边界处断开。
2. LUT6的bel输出SOUT仅连接到下一个LUT6的SIN输入，与以前的架构不同，在以前的架构中该引脚还可以通过站点输出连接到互连。
3. SRL不能与LUTRAM或切片中的LUT组合。
4. LUT之间的移位方向是从A->H，与以前的架构相反。在LUT内部的移位方向仍然是从最低有效位（LSB）到最高有效位（HSB）。
5. 支持双边沿时钟。
![](paper/versal_shift_register_srl_cascade.png)

SRL在内部以类似于进位链的方式级联。它们在逻辑上相邻的LUT之间级联（A_M->B_M->C_M->D_M->E_M->F_M->G_M->H_M），也可以在CLB之间级联（H_M->A_M）。这使得可以创建任意长度的SRL链。与以前的架构不同，没有存储器单元输出到逻辑，但如果链中最后一个LUT的读解码器用于通过LUT输出引脚将SRL输出带出，则SRL输出仍然可以到达互连。



# questions




414.56
87.62